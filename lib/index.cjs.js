"use strict";var a=require("vue");function M(s,d){if(s.width>s.height){const e=d/s.width,t=~~(s.height*e),l=(d-t)/2;return{x:0,y:l,width:d,height:t,maxWidth:d,maxHeight:l+t,scale:e}}const u=d/s.height,h=~~(s.width*u),x=(d-h)/2;return{x,y:0,width:h,height:d,maxWidth:x+h,maxHeight:d,scale:u}}function p(s,d){const{cursor:u}=d;return h=>{const x=document.body.style.cursor;document.body.style.cursor=u;const e={x:h.clientX,y:h.clientY},t=g=>{const{x:v,y:i}=s({x:g.clientX-e.x,y:g.clientY-e.y});e.x+=v,e.y+=i},l=()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",l),document.body.style.cursor=x};document.addEventListener("mousemove",t),document.addEventListener("mouseup",l)}}function P(s){const{sizeRef:d,minSizeRef:u,imageRef:h,initPaddingRef:x}=s,e=a.reactive({x:0,y:0,width:0,height:0}),t=a.computed(()=>{const{width:i=0,height:n=0}=h.value||{};return M({width:i,height:n},d.value)}),l=a.computed(()=>{const i=t.value;return{x:e.x-i.x,y:e.y-i.y,width:e.width,height:e.height}});a.watchEffect(()=>{const i=t.value,n=x.value;e.x=i.x+n,e.y=i.y+n,e.width=i.width-n*2,e.height=i.height-n*2});const g=p(({x:i,y:n})=>{const{x:r,y:c}=e,m=t.value;return e.x=Math.min(Math.max(e.x+i,m.x),m.maxWidth-e.width),e.y=Math.min(Math.max(e.y+n,m.y),m.maxHeight-e.height),{x:e.x-r,y:e.y-c}},{cursor:"move"}),v=[{directions:["n","w"],onDrag:p(({x:i,y:n})=>{const{x:r,y:c,width:m,height:o}=e,w=t.value,f=u.value;e.x=Math.min(Math.max(e.x+i,w.x),r+m-f),e.y=Math.min(Math.max(e.y+n,w.y),c+o-f);const R=e.x-r,S=e.y-c;return e.width-=R,e.height-=S,{x:R,y:S}},{cursor:"nw-resize"}),cursor:"nw-resize"},{directions:["n","c"],onDrag:p(({y:i})=>{const{y:n,height:r}=e,c=t.value,m=u.value;e.y=Math.min(Math.max(e.y+i,c.y),n+r-m);const o=e.y-n;return e.height-=o,{x:0,y:o}},{cursor:"n-resize"}),cursor:"n-resize"},{directions:["n","e"],onDrag:p(({x:i,y:n})=>{const{y:r,width:c,height:m}=e,o=t.value,w=u.value;e.y=Math.min(Math.max(e.y+n,o.y),r+m-w);const f=e.y-r;return e.width=Math.min(Math.max(e.width+i,w),o.maxWidth-e.x),e.height=Math.min(Math.max(e.height-f,0),o.maxHeight-e.y),{x:e.width-c,y:f}},{cursor:"ne-resize"}),cursor:"ne-resize"},{directions:["e","c"],onDrag:p(({x:i})=>{const{width:n}=e,r=t.value,c=u.value;return e.width=Math.min(Math.max(e.width+i,c),r.maxWidth-e.x),{x:e.width-n,y:0}},{cursor:"e-resize"}),cursor:"e-resize"},{directions:["s","e"],onDrag:p(({x:i,y:n})=>{const{width:r,height:c}=e,m=t.value,o=u.value;return e.width=Math.min(Math.max(e.width+i,o),m.maxWidth-e.x),e.height=Math.min(Math.max(e.height+n,o),m.maxHeight-e.y),{x:e.width-r,y:e.height-c}},{cursor:"se-resize"}),cursor:"se-resize"},{directions:["s","c"],onDrag:p(({y:i})=>{const{height:n}=e,r=t.value,c=u.value;return e.height=Math.min(Math.max(e.height+i,c),r.maxHeight-e.y),{x:0,y:e.height-n}},{cursor:"s-resize"}),cursor:"s-resize"},{directions:["s","w"],onDrag:p(({x:i,y:n})=>{const{x:r,width:c,height:m}=e,o=t.value,w=u.value;e.x=Math.min(Math.max(e.x+i,o.x),r+c-w);const f=e.x-r;return e.width=Math.min(Math.max(e.width-f,0),o.maxWidth-e.x),e.height=Math.min(Math.max(e.height+n,w),o.maxHeight-e.y),{x:f,y:e.height-m}},{cursor:"sw-resize"}),cursor:"sw-resize"},{directions:["w","c"],onDrag:p(({x:i})=>{const{x:n,width:r}=e,c=t.value,m=u.value;e.x=Math.min(Math.max(e.x+i,c.x),n+r-m);const o=e.x-n;return e.width=Math.min(Math.max(e.width-o,0),c.maxWidth-e.x),{x:o,y:0}},{cursor:"w-resize"}),cursor:"w-resize"}];return{controlShapeReactive:e,controls:v,onContainerDrag:g,cropShapeRef:l,imageScaleRef:t}}function N(s){return new Promise(d=>{const u=new Image;u.onload=()=>{d(u)},u.src=s})}function W(s){const{sizeRef:d,maskColorRef:u,controlShapeReactive:h}=s,x=a.ref(),e=a.computed(()=>{var t;return(t=x.value)==null?void 0:t.getContext("2d")});return a.watchEffect(()=>{const t=e.value;if(!t)return;const l=d.value,g=u.value;t.clearRect(0,0,l,l),t.fillStyle=g,t.fillRect(0,0,l,h.y),t.fillRect(0,h.y,h.x,h.height),t.fillRect(h.x+h.width,h.y,l-h.x-h.width,h.height),t.fillRect(0,h.y+h.height,l,l-h.y-h.height)}),{maskCanvasRef:x}}function D(s){const{cropShapeRef:d,imageScaleRef:u,previewSizeRef:h,previewPixelRatioRef:x,imageRef:e}=s,t=a.ref(),l=a.computed(()=>{var v;return(v=t.value)==null?void 0:v.getContext("2d")}),g=a.computed(()=>M(d.value,h.value));return a.watchEffect(()=>{const v=l.value,i=e.value;if(!v||!i)return;const n=d.value,r=g.value,{scale:c}=u.value,m=h.value,o=x.value,w=m*o;v.clearRect(0,0,w,w),v.drawImage(i,n.x/c,n.y/c,n.width/c,n.height/c,r.x*o,r.y*o,r.width*o,r.height*o)}),{previewCanvasRef:t}}const H="wrapper_JihDV",Y="controls_y3XJZ",k="control_J90Y3",V="n_-8OgP",X="c_6LXEx",b="w_Th9OP",E="e_dQiaQ",_="s_5Egfa",$="size_AeSSY",T="preview_2B7Cw";var y={wrapper:H,controls:Y,control:k,n:V,c:X,w:b,e:E,s:_,size:$,preview:T};const L=a.defineComponent({props:{src:String,size:{type:Number,default:400},minSize:{type:Number,default:20},showSize:{type:Boolean,default:!0},maskColor:{type:String,default:"#00000032"},initPadding:{type:Number,default:0},previewTo:Object,previewSize:{type:Number,default:50},previewPixelRatio:{type:Number,default:devicePixelRatio}},setup(s){const d=a.toRef(s,"size"),u=a.toRef(s,"minSize"),h=a.toRef(s,"maskColor"),x=a.toRef(s,"initPadding"),e=a.toRef(s,"previewSize"),t=a.toRef(s,"previewPixelRatio"),l=a.ref(),{controlShapeReactive:g,cropShapeRef:v,imageScaleRef:i,controls:n,onContainerDrag:r}=P({sizeRef:d,minSizeRef:u,initPaddingRef:x,imageRef:l}),{maskCanvasRef:c}=W({sizeRef:d,maskColorRef:h,controlShapeReactive:g}),{previewCanvasRef:m}=D({cropShapeRef:v,imageScaleRef:i,imageRef:l,previewSizeRef:e,previewPixelRatioRef:t});return a.watchEffect(async()=>{const o=s.src;o&&(l.value=await N(o))}),()=>{const{size:o,previewPixelRatio:w,previewSize:f}=s,R=i.value,S=f*w;return a.createVNode("div",{class:y.wrapper,style:{width:`${o}px`,height:`${o}px`},draggable:!1},[!!l.value&&a.createVNode(a.Fragment,null,[a.createVNode("img",{src:s.src,style:{width:`${R.width}px`,height:`${R.height}px`}},null),a.createVNode("canvas",{width:o,height:o,class:y.mask,ref:c},null),a.createVNode("div",{class:y.controls,style:{transform:`translate(${g.x}px, ${g.y}px)`,width:`${g.width}px`,height:`${g.height}px`},onMousedown:a.withModifiers(r,["stop"])},[!!s.showSize&&a.createVNode("div",{class:y.size,style:{transform:`translateY(${g.y>22?"-100%":0})`}},[g.width,a.createTextVNode(" x "),g.height]),n.map(z=>a.createVNode("div",{key:z.directions.join(""),class:[...z.directions.map(C=>y[C]),y.control],onMousedown:a.withModifiers(z.onDrag,["stop"]),style:{cursor:z.cursor}},null))])]),!!s.previewTo&&a.createVNode(a.Teleport,{to:s.previewTo},{default:()=>[a.createVNode("canvas",{width:S,height:S,ref:m,class:y.preview},null)]})])}}});module.exports=L;
